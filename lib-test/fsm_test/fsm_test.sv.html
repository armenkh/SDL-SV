<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<title>/media/sda3/data/repository/sdl_uvm_lib/lib-test/fsm_test/fsm_test.sv.html</title>
<meta name="Generator" content="Vim/7.3">
<meta name="plugin-version" content="vim7.3_v6">
<meta name="syntax" content="verilog_systemverilog">
<meta name="settings" content="use_css">
<style type="text/css">
<!--
pre { font-family: monospace; color: #000000; background-color: #ffffff; }
body { font-family: monospace; color: #000000; background-color: #ffffff; }
.Constant { color: #ff00ff; }
.PreProc { color: #a520f7; }
.Identifier { color: #008a8c; }
.Type { color: #298a52; font-weight: bold; }
.Comment { color: #0000ff; }
.Special { color: #6b59ce; }
.Statement { color: #a52829; font-weight: bold; }
-->
</style>
</head>
<body>
<pre>
<span class="Statement">module</span> fsm_test<span class="Special">;</span>

<span class="Comment">// Importing UVM and SDL packages</span>

<span class="Statement">import</span> uvm_pkg<span class="Special">::*;</span>
<span class="Statement">import</span> sdl_pkg<span class="Special">::*;</span>

<span class="Comment">/********************************************************/</span>
<span class="Comment">/********************************************************/</span>
<span class="Comment">/********************************************************/</span>
<span class="Comment">//Declaring signal by extending sdl_signal_base class</span>

<span class="Comment">//The ConnectRequest signal</span>
  <span class="Statement">class</span> ConnectRequest_sig <span class="Statement">extends</span> sdl_signal_base<span class="Special">;</span>
    <span class="Statement">function</span> <span class="Statement">new</span><span class="Special">(</span><span class="Statement">string</span> name<span class="Special">,</span> <span class="Type">uvm_component</span> initiator <span class="Special">=</span> <span class="Statement">null</span><span class="Special">);</span>
      <span class="Statement">super</span><span class="Identifier">.new</span> <span class="Special">(</span>name<span class="Special">,</span> initiator<span class="Special">);</span>
    <span class="Statement">endfunction</span>
  <span class="Statement">endclass</span>

<span class="Comment">//The ConnectRequestAck signal</span>
  <span class="Statement">class</span> ConnectRequestAck_sig <span class="Statement">extends</span> sdl_signal_base<span class="Special">;</span>
    <span class="Statement">function</span> <span class="Statement">new</span><span class="Special">(</span><span class="Statement">string</span> name<span class="Special">,</span> <span class="Type">uvm_component</span> initiator <span class="Special">=</span> <span class="Statement">null</span><span class="Special">);</span>
      <span class="Statement">super</span><span class="Identifier">.new</span> <span class="Special">(</span>name<span class="Special">,</span> initiator<span class="Special">);</span>
    <span class="Statement">endfunction</span>
  <span class="Statement">endclass</span>

<span class="Comment">//The Query signal</span>
<span class="Statement">class</span> Query_sig <span class="Statement">extends</span> sdl_signal_base<span class="Special">;</span>
<span class="Comment">//The signal has two parameters</span>
  <span class="Statement">int</span> value1<span class="Special">;</span>
  <span class="Statement">int</span> value2<span class="Special">;</span>
  <span class="Statement">function</span> <span class="Statement">new</span><span class="Special">(</span><span class="Statement">string</span> name<span class="Special">,</span> <span class="Type">uvm_component</span> initiator <span class="Special">=</span> <span class="Statement">null</span><span class="Special">);</span>
    <span class="Statement">super</span><span class="Identifier">.new</span> <span class="Special">(</span>name<span class="Special">,</span> initiator<span class="Special">);</span>
  <span class="Statement">endfunction</span>
<span class="Comment">//Setting parameters values</span>
  <span class="Statement">function</span> <span class="Statement">void</span> set_values<span class="Special">(</span><span class="Statement">int</span> v1<span class="Special">,</span> <span class="Statement">int</span> v2<span class="Special">);</span>
    <span class="Statement">this</span><span class="Special">.</span>value1 <span class="Special">=</span> v1<span class="Special">;</span>
    <span class="Statement">this</span><span class="Special">.</span>value2 <span class="Special">=</span> v2<span class="Special">;</span>
  <span class="Statement">endfunction</span>
<span class="Statement">endclass</span>

<span class="Comment">//The Result signal</span>
<span class="Statement">class</span> Result_sig <span class="Statement">extends</span> sdl_signal_base<span class="Special">;</span>
<span class="Comment">//Has one parameter</span>
  <span class="Statement">int</span> sum<span class="Special">;</span>
  <span class="Statement">function</span> <span class="Statement">new</span><span class="Special">(</span><span class="Statement">string</span> name<span class="Special">,</span> <span class="Type">uvm_component</span> initiator <span class="Special">=</span> <span class="Statement">null</span><span class="Special">);</span>
    <span class="Statement">super</span><span class="Identifier">.new</span> <span class="Special">(</span>name<span class="Special">,</span> initiator<span class="Special">);</span>
  <span class="Statement">endfunction</span>
<span class="Comment">//Setting parameter value</span>
  <span class="Statement">function</span> set_values<span class="Special">(</span><span class="Statement">int</span> sum<span class="Special">);</span>
    <span class="Statement">this</span><span class="Identifier">.sum</span> <span class="Special">=</span> sum<span class="Special">;</span>
  <span class="Statement">endfunction</span>
<span class="Statement">endclass</span>

<span class="Comment">/********************************************************/</span>
<span class="Comment">/********************************************************/</span>
<span class="Comment">/********************************************************/</span>
<span class="Comment">//Defining EFSM states</span>

<span class="Comment">//Using macro to declare WaitConReq state class</span>
<span class="PreProc">`DEFINE_SDL_STATE</span><span class="Special">(</span>WaitConReq_state<span class="Special">)</span>

<span class="Comment">//Defining state run function for WaitConReq state</span>
<span class="Statement">task</span> WaitConReq_state<span class="Special">::</span><span class="Identifier">run</span><span class="Special">();</span>
<span class="Comment">// In this state we should send ConnectRequestAck and go</span>
<span class="Comment">// to WaitQuery state.</span>
  send_signal<span class="Special">(</span><span class="Constant">&quot;ConnectRequestAck&quot;</span><span class="Special">);</span>
  set_next_state<span class="Special">(</span><span class="Constant">&quot;WaitQuery&quot;</span><span class="Special">);</span>
<span class="Statement">endtask</span>

<span class="Comment">//Using macro to declare WaitQuery state class</span>
<span class="PreProc">`DEFINE_SDL_STATE</span><span class="Special">(</span>WaitQuery_state<span class="Special">)</span>

<span class="Comment">//Defining state run function for WaitQuery state</span>
<span class="Statement">task</span> WaitQuery_state<span class="Special">::</span><span class="Identifier">run</span><span class="Special">();</span>
<span class="Comment">//Getting signal</span>
<span class="Comment">//Some checkers should be added here</span>
  Query_sig Query<span class="Special">;</span>
  <span class="PreProc">$cast</span><span class="Special">(</span>Query<span class="Special">,</span>m_fsm<span class="Special">.</span>m_current_event<span class="Special">);</span>

<span class="Comment">//Updating parameters</span>
  m_fsm<span class="Special">.</span>value1 <span class="Special">=</span> Query<span class="Special">.</span>value1<span class="Special">;</span>
  m_fsm<span class="Special">.</span>value2 <span class="Special">=</span> Query<span class="Special">.</span>value2<span class="Special">;</span>

<span class="Comment">//Calling sum task and updating values</span>
  m_fsm<span class="Special">.</span>calculate_sum<span class="Special">();</span>
  m_fsm<span class="Special">.</span>Result<span class="Special">.</span>set_values<span class="Special">(</span>m_fsm<span class="Identifier">.sum</span><span class="Special">);</span>
<span class="Comment">//Sending signal Result and changing state to WaitConReq</span>
  send_signal<span class="Special">(</span><span class="Constant">&quot;Result&quot;</span><span class="Special">);</span>
  set_next_state<span class="Special">(</span><span class="Constant">&quot;WaitConReq&quot;</span><span class="Special">);</span>
<span class="Statement">endtask</span>

<span class="Comment">/********************************************************/</span>
<span class="Comment">/********************************************************/</span>
<span class="Comment">/********************************************************/</span>
<span class="Comment">// Actual state machine implementation</span>
<span class="Comment">// Declaring &quot;Server&quot; EFSM by extending</span>
<span class="Comment">// sdl_fsm_base class</span>

<span class="Statement">class</span> server <span class="Statement">extends</span> sdl_fsm_base<span class="Special">;</span>

<span class="Comment">// Declaring States</span>
  WaitConReq_state <span class="Special">#(</span>server<span class="Special">)</span> WaitConReq<span class="Special">;</span>
  WaitQuery_state <span class="Special">#(</span>server<span class="Special">)</span> WaitQuery<span class="Special">;</span>

<span class="Comment">//Declaring signal that state machine should send out</span>
  ConnectRequestAck_sig ConnectRequestAck<span class="Special">;</span>
  Result_sig Result<span class="Special">;</span>

<span class="Comment">//Declaring EFSM local parameters</span>
  <span class="Statement">integer</span> sum<span class="Special">,</span> value1<span class="Special">,</span> value2<span class="Special">;</span>

<span class="Comment">// Class constructor</span>
  <span class="Statement">function</span> <span class="Statement">new</span><span class="Special">(</span><span class="Statement">string</span> name<span class="Special">,</span> <span class="Type">uvm_component</span> parent<span class="Special">);</span>
    <span class="Statement">super</span><span class="Identifier">.new</span><span class="Special">(</span>name<span class="Special">,</span>parent<span class="Special">);</span>
  <span class="Comment">// Initializing states and sygnals</span>
    WaitConReq <span class="Special">=</span> <span class="Statement">new</span><span class="Special">(</span><span class="Constant">&quot;WaitConReq&quot;</span><span class="Special">,</span> <span class="Statement">this</span><span class="Special">);</span>
    WaitQuery <span class="Special">=</span> <span class="Statement">new</span><span class="Special">(</span><span class="Constant">&quot;WaitQuery&quot;</span><span class="Special">,</span> <span class="Statement">this</span><span class="Special">);</span>
    ConnectRequestAck <span class="Special">=</span> <span class="Statement">new</span><span class="Special">(</span><span class="Constant">&quot;ConnectRequestAck&quot;</span><span class="Special">,</span> <span class="Statement">this</span><span class="Special">);</span>
    Result <span class="Special">=</span> <span class="Statement">new</span><span class="Special">(</span><span class="Constant">&quot;Result&quot;</span><span class="Special">,</span> <span class="Statement">this</span><span class="Special">);</span>
  <span class="Statement">endfunction</span>

<span class="Comment">//During UVM build_phase we will register states and signals</span>
<span class="Comment">//as well as we should set initial state</span>
  <span class="Statement">function</span> <span class="Statement">void</span> build_phase<span class="Special">(</span>uvm_phase phase<span class="Special">);</span>
  <span class="Comment">//Setting initial state</span>
    set_initial_state<span class="Special">(</span>WaitConReq<span class="Special">);</span>
  <span class="Comment">//Registering States with EFSM</span>
    register_state<span class="Special">(</span>WaitConReq<span class="Special">);</span>
    register_state<span class="Special">(</span>WaitQuery<span class="Special">);</span>
  <span class="Comment">//Registering sygnals</span>
    register_signal<span class="Special">(</span>ConnectRequestAck<span class="Special">);</span>
    register_signal<span class="Special">(</span>Result<span class="Special">);</span>
    <span class="Statement">super</span><span class="Special">.</span>build_phase<span class="Special">(</span>phase<span class="Special">);</span>
  <span class="Statement">endfunction</span>

<span class="Comment">//The task to calculate sum of parameters</span>
  <span class="Statement">function</span> <span class="Statement">void</span> calculate_sum<span class="Special">;</span>
    <span class="Statement">this</span><span class="Identifier">.sum</span> <span class="Special">=</span> <span class="Statement">this</span><span class="Special">.</span>value1 <span class="Special">+</span> <span class="Statement">this</span><span class="Special">.</span>value2<span class="Special">;</span>
  <span class="Statement">endfunction</span>

<span class="Statement">endclass</span>

<span class="Comment">//Test environment</span>

  <span class="Statement">class</span> env <span class="Statement">extends</span> <span class="Type">uvm_env</span><span class="Special">;</span>

<span class="Comment">//The server state machine declaration</span>
  server server_i<span class="Special">;</span>
<span class="Comment">//environment ports for sending/receiving signals to/from server</span>
  sdl_put_port data_out<span class="Special">;</span>
  sdl_get_port data_in<span class="Special">;</span>

<span class="Comment">// We will use sdl fifos to connect environment to EFSM</span>
<span class="Comment">// See corresponding posts about sdl fifos and comunications</span>
  sdl_process_input_fifo_base inf<span class="Special">;</span>
  sdl_process_input_fifo_base out<span class="Special">;</span>

<span class="Comment">//Declaring signals</span>
  ConnectRequest_sig ConnectRequest<span class="Special">;</span>
  Query_sig Query<span class="Special">;</span>
  Result_sig Result<span class="Special">;</span>
  sdl_signal_base temp_signal<span class="Special">;</span>

<span class="Comment">//The constructor will create environment ports, EFSM and sdl fifos</span>
  <span class="Statement">function</span> <span class="Statement">new</span> <span class="Special">(</span><span class="Statement">string</span> name<span class="Special">=</span><span class="Constant">&quot;env&quot;</span><span class="Special">,</span> <span class="Type">uvm_component</span> parent<span class="Special">=</span><span class="Statement">null</span><span class="Special">);</span>
    <span class="Statement">super</span><span class="Identifier">.new</span><span class="Special">(</span>name<span class="Special">,</span>parent<span class="Special">);</span>
    data_out <span class="Special">=</span> <span class="Statement">new</span><span class="Special">(</span><span class="Constant">&quot;data_out&quot;</span><span class="Special">,</span> parent<span class="Special">);</span>
    data_in <span class="Special">=</span> <span class="Statement">new</span><span class="Special">(</span><span class="Constant">&quot;data_in&quot;</span><span class="Special">,</span> parent<span class="Special">);</span>
    server_i <span class="Special">=</span> <span class="Statement">new</span> <span class="Special">(</span><span class="Constant">&quot;server&quot;</span><span class="Special">,</span> parent<span class="Special">);</span>
    inf <span class="Special">=</span> <span class="Statement">new</span> <span class="Special">(</span><span class="Constant">&quot;inf&quot;</span><span class="Special">,</span> parent<span class="Special">);</span>
    out <span class="Special">=</span> <span class="Statement">new</span><span class="Special">(</span><span class="Constant">&quot;out&quot;</span><span class="Special">,</span> parent<span class="Special">);</span>
  <span class="Statement">endfunction</span>

<span class="Comment">//UVM run_phase</span>
  <span class="Statement">task</span> run_phase<span class="Special">(</span>uvm_phase phase<span class="Special">);</span>
    phase<span class="Special">.</span>raise_objection<span class="Special">(</span><span class="Statement">this</span><span class="Special">);</span>

    <span class="Comment">// 1. Environment sends ConnectRequest to server</span>
    ConnectRequest <span class="Special">=</span> <span class="Statement">new</span><span class="Special">(</span><span class="Constant">&quot;ConnectRequest&quot;</span><span class="Special">,</span> <span class="Statement">this</span><span class="Special">);</span>
    data_out<span class="Special">.</span>put_signal<span class="Special">(</span>ConnectRequest<span class="Special">);</span>

    <span class="Comment">//2. Environment waits for ConnectRequestAck</span>
    data_in<span class="Special">.</span>get_signal<span class="Special">(</span>temp_signal<span class="Special">);</span>
    <span class="Statement">if</span><span class="Special">(</span> temp_signal<span class="Special">.</span><span class="Identifier">get_name</span><span class="Special">()</span> <span class="Special">!=</span> <span class="Constant">&quot;ConnectRequestAck&quot;</span><span class="Special">)</span> <span class="Statement">begin</span>
      <span class="PreProc">`sdl_error</span> <span class="Special">(</span><span class="PreProc">$psprintf</span><span class="Special">(</span><span class="Constant">&quot;Env got wrong signal: %s&quot;</span><span class="Special">,</span> temp_signal<span class="Special">.</span><span class="Identifier">get_name</span><span class="Special">()))</span>
      <span class="PreProc">$finish</span><span class="Special">;</span>
    <span class="Statement">end</span>
    <span class="PreProc">`sdl_info</span><span class="Special">(</span><span class="PreProc">$psprintf</span><span class="Special">(</span><span class="Constant">&quot;Env got: %s&quot;</span><span class="Special">,</span> temp_signal<span class="Special">.</span><span class="Identifier">get_name</span><span class="Special">()),</span><span class="Constant">UVM_LOW</span><span class="Special">)</span>

    <span class="Comment">// 3. Environment sends the Query</span>
    Query <span class="Special">=</span> <span class="Statement">new</span><span class="Special">(</span><span class="Constant">&quot;Query&quot;</span><span class="Special">,</span> <span class="Statement">this</span><span class="Special">);</span>
    Query<span class="Special">.</span>set_values<span class="Special">(</span><span class="Constant">2</span><span class="Special">,</span> <span class="Constant">3</span><span class="Special">);</span>
    <span class="PreProc">`sdl_info</span><span class="Special">(</span><span class="PreProc">$psprintf</span><span class="Special">(</span><span class="Constant">&quot;CLIENT Sends: %d, %d&quot;</span><span class="Special">,</span> <span class="Constant">2</span><span class="Special">,</span><span class="Constant">3</span><span class="Special">),</span><span class="Constant">UVM_LOW</span><span class="Special">)</span>
    data_out<span class="Special">.</span>put_signal<span class="Special">(</span>Query<span class="Special">);</span>

    <span class="Comment">// 4. Environment waits for Result</span>
    data_in<span class="Special">.</span>get_signal<span class="Special">(</span>temp_signal<span class="Special">);</span>
    <span class="Statement">if</span><span class="Special">(</span> temp_signal<span class="Special">.</span><span class="Identifier">get_name</span><span class="Special">()</span> <span class="Special">!=</span> <span class="Constant">&quot;Result&quot;</span><span class="Special">)</span> <span class="Statement">begin</span>
      <span class="PreProc">`sdl_error</span> <span class="Special">(</span><span class="PreProc">$psprintf</span><span class="Special">(</span><span class="Constant">&quot;Env got wrong signal: %s&quot;</span><span class="Special">,</span> temp_signal<span class="Special">.</span><span class="Identifier">get_name</span><span class="Special">()))</span>
      <span class="PreProc">$finish</span><span class="Special">;</span>
    <span class="Statement">end</span>
    <span class="PreProc">`sdl_info</span><span class="Special">(</span><span class="PreProc">$psprintf</span><span class="Special">(</span><span class="Constant">&quot;Env got: %s&quot;</span><span class="Special">,</span> temp_signal<span class="Special">.</span><span class="Identifier">get_name</span><span class="Special">()),</span><span class="Constant">UVM_LOW</span><span class="Special">)</span>
    <span class="PreProc">$cast</span><span class="Special">(</span>Result<span class="Special">,</span>temp_signal<span class="Special">);</span>
    <span class="PreProc">`sdl_info</span><span class="Special">(</span><span class="PreProc">$psprintf</span><span class="Special">(</span><span class="Constant">&quot;SERVER Returns: %d&quot;</span><span class="Special">,</span> Result<span class="Identifier">.sum</span><span class="Special">),</span><span class="Constant">UVM_LOW</span><span class="Special">)</span>
    phase<span class="Special">.</span>drop_objection<span class="Special">(</span><span class="Statement">this</span><span class="Special">);</span>
  <span class="Statement">endtask</span>

<span class="Comment">//UVM connect_phase</span>
  <span class="Statement">function</span> <span class="Statement">void</span> connect_phase<span class="Special">(</span>uvm_phase phase<span class="Special">);</span>
  <span class="Comment">//Connecting EFSM to environment ports</span>
    server_i<span class="Special">.</span><span class="Identifier">get_port</span><span class="Special">.</span><span class="Identifier">connect</span><span class="Special">(</span>inf<span class="Special">.</span>get_export<span class="Special">);</span>
    data_out<span class="Special">.</span><span class="Identifier">connect</span><span class="Special">(</span>inf<span class="Special">.</span>put_export<span class="Special">);</span>
    server_i<span class="Special">.</span>put_port<span class="Special">.</span><span class="Identifier">connect</span><span class="Special">(</span>out<span class="Special">.</span>put_export<span class="Special">);</span>
    data_in<span class="Special">.</span><span class="Identifier">connect</span><span class="Special">(</span>out<span class="Special">.</span>get_export<span class="Special">);</span>

  <span class="Statement">endfunction</span> <span class="Special">:</span> connect_phase

<span class="Statement">endclass</span>

  env e <span class="Special">=</span> <span class="Statement">new</span><span class="Special">(</span><span class="Constant">&quot;env&quot;</span><span class="Special">,</span> <span class="Statement">null</span><span class="Special">);</span>
  <span class="Statement">initial</span> <span class="Statement">begin</span>
     <span class="Identifier">run_test</span><span class="Special">();</span>
  <span class="Statement">end</span>


<span class="Statement">endmodule</span>
</pre>
</body>
</html>
